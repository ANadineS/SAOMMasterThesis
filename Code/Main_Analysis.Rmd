---
title: "Main Analysis"
author: "Astrid Stulemeijer"
date: "2024-04-17"
output: html_document
---

# Preparations
## Loading needed packages, data & scripts
```{r}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# Load R Packages
library(RSiena)
library(dplyr)
library(ggplot2)
library(igraph)
library(sna)
library(network)
library(RColorBrewer)
library(GGally)
library(reshape2)
library(parallel)

# Load Data
load("../Data/Input/Glasgow-friendship.RData")
load("../Data/Input/Glasgow-demographic.RData")

# Source Scripts
source("./SimulationRun.R")
source("./HelperFunctions.R")
source("./FormatOutput.R")
```

## Data Preparation
```{r}
# Only select actors that are active participants in both wave 2 and 3 
noresponse_1 <- apply(friendship.2, 1, function(row) all(is.na(row) | row == 10))
noresponse_2 <- apply(friendship.3, 1, function(row) all(is.na(row) | row == 10))
inactive <- noresponse_1 | noresponse_2

netwmatrices <- list(friendship.2[!inactive, !inactive], friendship.3[!inactive, !inactive]) %>%
  lapply(., function(x) apply(x,1, function(y) replace(y,y == 2, 1))) # Create network without weights

# Coding sex as 0/1
sex <- ifelse(sex.F[!inactive] == 1, 0, 1)
sex2 <- coCovar(sex, centered = F)
```

## Creating Relevant Objects
```{r}
set.seed(2809)

controls <- sienaAlgorithmCreate(seed = 2809)

# Creating "Real" SAOM model & second observations generated based on the second model
if (file.exists("../Data/Output/RealModel.RData")){
  realmodel <- readRDS("../Data/Output/RealModel.RData")
  second_observations <- readRDS("../Data/Output/SecondObservations.RData")
} else{
  
  # Real Model
  friendship <- sienaDependent(array(c(netwmatrices[[1]], netwmatrices[[2]]), 
                                   dim = c(133,133,2)))
  glasgowdata <- sienaDataCreate(friendship, sex2)
  
  effects <- getEffects(glasgowdata)
  effects <- includeEffects(effects, name = "friendship", 
                            density, recip, cycle3, gwespFF, transRecTrip, inPop, inAct)
  effects <- includeEffects(effects, name = "friendship", sameX, interaction1 = "sex2")
  
  realmodel <- siena07(controls, data = glasgowdata, effects = effects)
  
  # Second Observations
  set.seed(2809)
  simulation_controls <- sienaAlgorithmCreate(n3 = 500, nsub = 0)
  simulations <- siena07(simulation_controls, data = glasgowdata, effects = effects, 
                   returnDeps = T, prevAns = realmodel)
  
  second_observations_list <- lapply(lapply(lapply(simulations$sims, "[[", "Data1"), "[[", "friendship"), 
                                "[[", "1")
  second_observations <- lapply(second_observations_list, function(x)
                                as_adjacency_matrix(graph_from_edgelist(as.matrix(x[,-3]), directed = T)))
  
  
  saveRDS(realmodel, "../Data/Output/RealModel.RData")
  saveRDS(second_observations, "../Data/Output/SecondObservations.RData")
}

```

# Random Error Simulation
## Perform simulation
```{r}
n <- 70
neg_error <- c(0.1)
pos_error <- 0

simulation_element <- expand.grid(1:n, neg_error, pos_error)

cl <- makeCluster(detectCores()-1)
clusterExport(cl, c("SimulationRun", "IntroduceError_Random", "second_observations", "netwmatrices", "sex2", "controls", "simulation_element", "ChangeCoding"))

clusterEvalQ(cl, {library(igraph); library(RSiena)})

random_output <- parApply(cl, MARGIN = 1, X = as.matrix(simulation_element), FUN = function(x) SimulationRun(IntroduceError_Random, netwmatrices[[1]], second_observations[[x[1]]], sex2, controls, x[3], x[2]))

stopCluster(cl)

saveRDS(random_output, "../Data/Output/01_Random_Raw_Output.RData")
```

## Output Formatting
```{r}
random_output <- readRDS("../Data/Output/01_Random_Raw_Output.RData")
random_formatted <- FormatOutput(random_output)
saveRDS(random_formatted, "../Data/Output/01_Random_Formatted_Output.RData")
```

## Analysis
```{r}
error_combo <- expand.grid(neg_error, pos_error)
```